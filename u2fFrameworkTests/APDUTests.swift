//
//  APDUTests.swift
//  u2fFramework
//
//  Created by Владислав Лисянский on 17.10.16.
//  Copyright © 2016 Владислав Лисянский. All rights reserved.
//

import XCTest
@testable import u2fFramework
class APDUTests: XCTestCase {
    
    func testApduGeneration() {
        let apduData = APDU(INS: .register, P1: .registerHashID, DATA: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20, 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]).getData()
        let controlArray: [UInt8] = [0,0x81,0,0,0,0,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]
        XCTAssertEqual(apduData, Data(bytes: controlArray))
    }
    
    func testParseRegistrationResponse() {
        guard
            let responseArray = "0504843DC11044915A50B198A26ED9A836E1A0405EDF1C040D7FD27B9242D2A89AF4A29DF078A3350EB7B1D74F646664377BDF7EA07989D3A29D25076634237F2CE9404E307D46E7E11077CB3218346CCC56540BE727575D99AA16C3DF933D0AD3852C9EEC6726AA647E64ED4DC96F531249E94877C814174A51CB7C675F72FAC34DE63082013C3081E4A003020102020A47901280001155957352300A06082A8648CE3D0403023017311530130603550403130C476E756262792050696C6F74301E170D3132303831343138323933325A170D3133303831343138323933325A3031312F302D0603550403132650696C6F74476E756262792D302E342E312D34373930313238303030313135353935373335323059301306072A8648CE3D020106082A8648CE3D03010703420004BA4D3F903986F6DD36FA8A9995FF64CC3AAA54C79495757CA0884EC648AD2F89B7283E16037F9532110E671926F9253CD35AE49CD7FA00E190C0533F2E7A02D1300A06082A8648CE3D0403020347003044022060CDB6061E9C22262D1AAC1D96D8C70829B2366531DDA268832CB836BCD30DFA0220631B1459F09E6330055722C8D89B7F48883B9089B88D60D1D9795902B30410DF30440220636F9BCD1463DE6655D1316E4DD3B8E8DE30C846673BCC02F76C2AB84D620149022037FB96E9AF3E9DDECD81C24950538E73D7C6F554BAC29295A49644B39BD910789000".hexToUInt8Array()
        else { XCTFail(); return }
        
        do {
            let parsed = try APDU.parseRegistrationResponse(Data(bytes: responseArray))
            guard
                let publicKey =  "04843DC11044915A50B198A26ED9A836E1A0405EDF1C040D7FD27B9242D2A89AF4A29DF078A3350EB7B1D74F646664377BDF7EA07989D3A29D25076634237F2CE9".hexToUInt8Array(),
                let keyHandle = "4E307D46E7E11077CB3218346CCC56540BE727575D99AA16C3DF933D0AD3852C9EEC6726AA647E64ED4DC96F531249E94877C814174A51CB7C675F72FAC34DE6".hexToUInt8Array(),
                let attestationCertificate = "3082013C3081E4A003020102020A47901280001155957352300A06082A8648CE3D0403023017311530130603550403130C476E756262792050696C6F74301E170D3132303831343138323933325A170D3133303831343138323933325A3031312F302D0603550403132650696C6F74476E756262792D302E342E312D34373930313238303030313135353935373335323059301306072A8648CE3D020106082A8648CE3D03010703420004BA4D3F903986F6DD36FA8A9995FF64CC3AAA54C79495757CA0884EC648AD2F89B7283E16037F9532110E671926F9253CD35AE49CD7FA00E190C0533F2E7A02D1300A06082A8648CE3D0403020347003044022060CDB6061E9C22262D1AAC1D96D8C70829B2366531DDA268832CB836BCD30DFA0220631B1459F09E6330055722C8D89B7F48883B9089B88D60D1D9795902B30410DF".hexToUInt8Array(),
                let signature = "30440220636F9BCD1463DE6655D1316E4DD3B8E8DE30C846673BCC02F76C2AB84D620149022037FB96E9AF3E9DDECD81C24950538E73D7C6F554BAC29295A49644B39BD91078".hexToUInt8Array()
                else { XCTFail(); return }

            XCTAssertEqual(Data(bytes: publicKey), parsed.publicKey)
            XCTAssertEqual(Data(bytes: keyHandle), parsed.keyHandle)
            XCTAssertEqual(Data(bytes: attestationCertificate), parsed.attestationCertificate)
            XCTAssertEqual(Data(bytes: signature), parsed.signature)
        } catch { XCTFail(); return }
    }
    
    func testParseAuthenticationResponse() {
        guard let responseArray = "01000000043045022100AC5708327BA162EC71AF28D41C19F13135A02462B05C8EC4B98DF5D7D41BA574022027CC9982028A7D2ADF9863898C34FBEEEACF35699FD8B2569F7AFCCE6C6881EC9000".hexToUInt8Array()
        else { XCTFail(); return }
        do {
            let parsed = try APDU.parseAuthenticationResponse(Data(bytes: responseArray))
            guard
                let userPresence = UInt8("01"),
                let counter = UInt32("00000004"),
                let signature = "3045022100AC5708327BA162EC71AF28D41C19F13135A02462B05C8EC4B98DF5D7D41BA574022027CC9982028A7D2ADF9863898C34FBEEEACF35699FD8B2569F7AFCCE6C6881EC".hexToUInt8Array()
            else { XCTFail(); return }
            
            XCTAssertEqual(userPresence, parsed.userPresence)
            XCTAssertEqual(counter, parsed.counter)
            XCTAssertEqual(Data(bytes: signature), parsed.signature)
        } catch { XCTFail(); return }
    }
}
